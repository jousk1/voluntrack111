{% extends "hub/base.html" %}
{% block content %}
<div class="row">
  <div class="col-md-8">
    <div class="card shadow mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <h2 class="card-title mb-0">{{ event.title }}</h2>
            {% if event.department %}<span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25">{{ event.department.name }}</span>{% endif %}
          </div>
          {% if user.profile.is_coordinator and event.created_by == user %}
            <div class="btn-group">
              <a href="{% url 'hub:event_edit' event.pk %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i> Edit</a>
              <a href="{% url 'hub:event_delete' event.pk %}" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i> Delete</a>
            </div>
          {% endif %}
        </div>
        <p class="text-muted mb-2"><i class="bi bi-calendar-event"></i> <strong>{{ event.date|date:"F d, Y" }}</strong> at {{ event.date|date:"g:i A" }}</p>
        <p class="text-muted mb-3"><i class="bi bi-geo-alt-fill"></i> {{ event.location }}</p>
        {% if event.description %}<div class="mb-4"><h5>Description</h5><p class="text-muted">{{ event.description|linebreaks }}</p></div>{% endif %}
        {% if has_hours_data %}
          <div class="mb-4">
            <h5>Hours Logged for this Event</h5>
            <p class="text-muted small">Approved hours per volunteer</p>
            <canvas id="eventHoursChart" height="220"></canvas>
          </div>
        {% endif %}
        <div class="d-flex flex-wrap gap-2 align-items-center">
          {% if event.status == "SCHEDULED" %}
            {% if signed %}
              <span class="badge bg-success fs-6"><i class="bi bi-check-circle-fill"></i> You're signed up</span>
            {% elif remaining is None %}
              <a class="btn btn-primary" href="{% url 'hub:event_signup' event.pk %}"><i class="bi bi-check-circle"></i> Sign Up</a>
              <span class="text-muted">Unlimited spots available</span>
            {% elif remaining > 0 %}
              <a class="btn btn-primary" href="{% url 'hub:event_signup' event.pk %}"><i class="bi bi-check-circle"></i> Sign Up</a>
              <span class="text-muted">{{ remaining }} spot{{ remaining|pluralize }} remaining</span>
            {% else %}
              <span class="badge bg-danger fs-6">Event is Full</span>
            {% endif %}
          {% elif event.status == "COMPLETED" %}
            <span class="badge bg-secondary fs-6">Event Completed</span>
          {% elif event.status == "CANCELLED" %}
            <span class="badge bg-danger fs-6">Event Cancelled</span>
          {% endif %}
          {% if user.is_authenticated and event.status == "SCHEDULED" %}
            {% if user.profile.is_coordinator or signed %}
              <a href="{% url 'hub:contribution_create' %}?event={{ event.pk }}" class="btn btn-outline-primary ms-auto">Log Work for this Event</a>
            {% endif %}
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow">
      <div class="card-header"><h5 class="mb-0">Event Details</h5></div>
      <div class="card-body">
        <dl class="mb-0">
          <dt>Capacity</dt><dd>{% if event.capacity == 0 %}Unlimited{% else %}{{ event.capacity }}{% endif %}</dd>
          <dt>Created by</dt><dd>{{ event.created_by.get_full_name|default:event.created_by.username }}</dd>
          <dt>Created on</dt><dd>{{ event.created_at|date:"M d, Y" }}</dd>
          <dt>Status</dt>
          <dd>
            {% if user.is_authenticated and user.profile.is_coordinator %}
              <form method="post" action="{% url 'hub:event_update_status' event.pk %}" class="d-flex gap-2">
                {% csrf_token %}
                <select name="status" class="form-select form-select-sm">
                  <option value="SCHEDULED" {% if event.status == "SCHEDULED" %}selected{% endif %}>Scheduled</option>
                  <option value="COMPLETED" {% if event.status == "COMPLETED" %}selected{% endif %}>Completed</option>
                  <option value="CANCELLED" {% if event.status == "CANCELLED" %}selected{% endif %}>Cancelled</option>
                </select>
                <button class="btn btn-sm btn-outline-secondary">Update</button>
              </form>
            {% else %}{{ event.get_status_display }}{% endif %}
          </dd>
        </dl>
      </div>
    </div>
    <div class="card shadow mt-3">
      <div class="card-header"><h5 class="mb-0">Participants</h5></div>
      <div class="card-body">
        {% if participants %}
          <ul class="list-unstyled mb-0">{% for s in participants %}<li>{{ s.user.get_full_name|default:s.user.username }}</li>{% endfor %}</ul>
        {% else %}<p class="text-muted mb-0">No one has signed up yet.</p>{% endif %}
      </div>
    </div>
  </div>
</div>
{% if has_hours_data %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  if (typeof Chart === "undefined") return;
  new Chart(document.getElementById("eventHoursChart"), {
    type: "bar",
    data: { labels: {{ hours_labels_json|safe }}, datasets: [{ label: "Hours", data: {{ hours_data_json|safe }}, backgroundColor: "#0d6efd" }] },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });
});
</script>
{% endif %}
{% endblock %}
