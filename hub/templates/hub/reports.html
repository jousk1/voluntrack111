{% extends "hub/base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>Reports & Insights</h2>
  <small class="text-muted">Data updates as contributions are submitted & approved</small>
</div>

<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <p class="text-muted mb-1">Total Approved Hours</p>
        <h3 class="mb-0">{{ total_hours|default:"0" }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <p class="text-muted mb-1">Pending Contributions</p>
        <h3 class="mb-0">{{ pending_total }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <p class="text-muted mb-1">Total Contributions Logged</p>
        <h3 class="mb-0">{{ total_contributions }}</h3>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-md-6">
    <div class="card p-3 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="card-title mb-0">Top 10 Volunteers</h5>
        <small class="text-muted">Approved hours</small>
      </div>
      {% if has_rank_data %}
        <canvas id="rankChart" height="220"></canvas>
      {% else %}
        <p class="text-muted mb-0">No approved contributions yet.</p>
      {% endif %}
    </div>
  </div>
  <div class="col-md-6">
    <div class="card p-3 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="card-title mb-0">Hours by Department</h5>
        <small class="text-muted">Share of approved time</small>
      </div>
      {% if has_dept_data %}
        <canvas id="deptChart" height="220"></canvas>
      {% else %}
        <p class="text-muted mb-0">No department data available.</p>
      {% endif %}
    </div>
  </div>
  <div class="col-12">
    <div class="card p-3 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="card-title mb-0">Average Hours per Contribution</h5>
        <small class="text-muted">By department</small>
      </div>
      {% if has_avg_data %}
        <canvas id="avgChart" height="260"></canvas>
      {% else %}
        <p class="text-muted mb-0">Average breakdown available after approvals.</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    if (typeof Chart === "undefined") {
      // Chart.js not loaded; avoid breaking the page
      return;
    }

    const palettes = [
      "#0d6efd", "#6610f2", "#6f42c1", "#d63384",
      "#fd7e14", "#f03", "#20c997", "#198754", "#0dcaf0", "#ffc107"
    ];

    function buildConfig(type, labels, data, options = {}) {
      return {
        type,
        data: {
          labels,
          datasets: [{
            label: options.datasetLabel || "Hours",
            data,
            backgroundColor: type === "bar" ? palettes : palettes,
            borderColor: "#fff",
            borderWidth: type === "pie" ? 2 : 1,
          }]
        },
        options: Object.assign({
          responsive: true,
          plugins: {
            legend: { display: type !== "bar" },
            tooltip: { enabled: true }
          },
          scales: type === "bar" ? {
            y: { beginAtZero: true }
          } : {}
        }, options.extra || {})
      };
    }

    {% if has_rank_data %}
      new Chart(
        document.getElementById("rankChart"),
        buildConfig(
          "bar",
          {{ rank_labels_json|safe }},
          {{ rank_data_json|safe }},
          { datasetLabel: "Hours" }
        )
      );
    {% endif %}

    {% if has_dept_data %}
      new Chart(
        document.getElementById("deptChart"),
        buildConfig(
          "pie",
          {{ dept_labels_json|safe }},
          {{ dept_data_json|safe }},
          { datasetLabel: "Share" }
        )
      );
    {% endif %}

    {% if has_avg_data %}
      new Chart(
        document.getElementById("avgChart"),
        buildConfig(
          "line",
          {{ avg_labels_json|safe }},
          {{ avg_data_json|safe }},
          {
            datasetLabel: "Avg Hours",
            extra: {
              tension: 0.4,
              fill: true,
              borderColor: "#0d6efd",
              backgroundColor: "rgba(13, 110, 253, 0.2)"
            }
          }
        )
      );
    {% endif %}
  });
</script>
{% endblock %}
