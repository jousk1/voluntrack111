{% extends "hub/base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>Contribution Management</h2>
  <span class="badge bg-info fs-6">
    {% if selected_department %}
      Showing: {{ selected_department.name }}
    {% else %}
      Showing: All Departments
    {% endif %}
  </span>
</div>

<!-- Status Tabs -->
<ul class="nav nav-tabs mb-4" role="tablist">
  <li class="nav-item" role="presentation">
    <a class="nav-link {% if status_filter == 'PENDING' %}active{% endif %}" href="?status=PENDING">
      Pending
      {% if pending_count > 0 %}
        <span class="badge bg-warning text-dark">{{ pending_count }}</span>
      {% endif %}
    </a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link {% if status_filter == 'APPROVED' %}active{% endif %}" href="?status=APPROVED">
      Approved
      {% if approved_count > 0 %}
        <span class="badge bg-success">{{ approved_count }}</span>
      {% endif %}
    </a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link {% if status_filter == 'REJECTED' %}active{% endif %}" href="?status=REJECTED">
      Rejected
      {% if rejected_count > 0 %}
        <span class="badge bg-danger">{{ rejected_count }}</span>
      {% endif %}
    </a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link {% if not status_filter %}active{% endif %}" href="?status=">
      All
    </a>
  </li>
</ul>

<!-- Filter Form -->
<div class="card mb-4">
  <div class="card-body">
    <form method="get" class="row g-3 align-items-end">
      <input type="hidden" name="status" value="{{ status_filter }}">
      <div class="col-md-5">
        <label for="department" class="form-label">Filter by Department</label>
        <select name="department" id="department" class="form-select">
          <option value="all" {% if dept_filter_value == "all" %}selected{% endif %}>All Departments</option>
          {% if my_department %}
            <option value="mine" {% if dept_filter_value == "mine" %}selected{% endif %}>My Department ({{ my_department.name }})</option>
          {% endif %}
          {% for dept in departments %}
            <option value="{{ dept.pk }}" {% if dept_filter_value == dept.pk|stringformat:"s" %}selected{% endif %}>{{ dept.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">Apply</button>
      </div>
      <div class="col-md-2">
        <a href="?status={{ status_filter }}" class="btn btn-outline-secondary w-100">Reset</a>
      </div>
    </form>
  </div>
</div>

<!-- Contributions List -->
{% if contributions %}
  <div class="row">
    {% for c in contributions %}
      <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100 shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <h6 class="card-title mb-0">{{ c.user.get_full_name|default:c.user.username }}</h6>
                <small class="text-muted">@{{ c.user.username }}</small>
              </div>
              {% if c.status == "PENDING" %}
                <span class="badge bg-warning text-dark">Pending</span>
              {% elif c.status == "APPROVED" %}
                <span class="badge bg-success">Approved</span>
              {% elif c.status == "REJECTED" %}
                <span class="badge bg-danger">Rejected</span>
              {% endif %}
            </div>
            
            <div class="mb-2">
              <span class="badge bg-secondary">{{ c.department.name }}</span>
              {% if c.event %}
                <span class="badge bg-info">{{ c.event.title|truncatewords:3 }}</span>
              {% endif %}
            </div>
            
            <div class="mb-2">
              <p class="mb-1">
                <strong>{{ c.hours }}h</strong> on {{ c.date|date:"M d, Y" }}
              </p>
              {% if c.description %}
                <p class="text-muted small mb-0">{{ c.description|truncatewords:15 }}</p>
              {% endif %}
            </div>
            
            {% if c.approved_by %}
              <div class="mb-2">
                <small class="text-muted">
                  {% if c.status == "APPROVED" %}
                    Approved by {{ c.approved_by.username }}
                  {% elif c.status == "REJECTED" %}
                    Rejected by {{ c.approved_by.username }}
                  {% endif %}
                  {% if c.approved_at %}
                    on {{ c.approved_at|date:"M d, Y" }}
                  {% endif %}
                </small>
              </div>
            {% endif %}
            
            <div class="mt-3">
              {% if c.status == "PENDING" %}
                <a href="{% url 'hub:approval_detail' c.pk %}" class="btn btn-sm btn-primary w-100">Review</a>
              {% else %}
                <a href="{% url 'hub:approval_detail' c.pk %}" class="btn btn-sm btn-outline-secondary w-100">View Details</a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="alert alert-info">
    <p class="mb-0">
      {% if status_filter == "PENDING" %}
        No pending contributions to review.
      {% elif status_filter == "APPROVED" %}
        No approved contributions found.
      {% elif status_filter == "REJECTED" %}
        No rejected contributions found.
      {% else %}
        No contributions found.
      {% endif %}
    </p>
  </div>
{% endif %}
{% endblock %}
